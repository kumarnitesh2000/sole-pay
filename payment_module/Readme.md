## payment module with payment process and auth(IAM)


## add .env file in root folder to start this application at 4000 exposing port
```
NODE_ENV=development
LOG_DIRECTORY=./logs/development
URI=MONGO_URI=mongodb+srv://apoorvgarg:postgres@cluster0.afa3u.mongodb.net/paydb?retryWrites=true&w=majority
PORT=4000
UPI_PAYMENT_LINK_BASE=upi://pay?
BASE_URL=http://localhost:4000
PASSPHRASE=testphrase
PRIVATE_PEM_FILE_PATH=private.pem
PUBLIC_PEM_FILE_PATH=public.pem
ADMIN_USERNAME=username
ADMIN_PASSWORD=password
ADMIN_APP_ID=623849d051491b1681028757
ADMIN_APP_SECRET=6d0e82d5c2d07b268571d295dd47271c
MOCKPAY_URL=http://localhost:8000/paylink/bill/generate
MOCKPAY_TOKEN=bml0ZXNoa3VtYXIyODoxMg==
```

## Run mongo server(not recommended because need to run as replicaSet)
```
docker run -it --rm --name mongo-db -p 27017:27017 -d mongo
```

## Run mongo client by downloading mongo compass
https://www.mongodb.com/try/download/compass
> open compass and connect with URI same as in env[URI]

## create pem files

### passphrase is same mentioned in .env file
private pem file creation
> openssl genrsa -des3 -out private.pem 2048

public pem file creation
> openssl rsa -in private.pem -pubout -outform PEM -out public.pem

```
npm i (for first time)
npm start
```
visit : http://localhost:4000/openapi/online for open apis and try `/health` api

## setup the payment-service application / init application

- go to `/app/admin` **post** request and just enter the `admin_secret` generated by `echo -n <env.ADMIN_USERNAME>:<env.ADMIN_PASSWORD> | base64`

### Output
> {
  "appId": "62cd563ecf61884add7d2441",
  "appSecret": "080bef8cc51c5096dab5805cf997a1c8"
}

- add this in {env.ADMIN_APP_ID} = appId, {env.ADMIN_APP_SECRET} = appSecret 

## create a admin of a application

- go to `/user/register` **post** request and just enter `{env.ADMIN_APP_ID}`, `{env.ADMIN_APP_SECRET}` from above

### Output
> {
  "hash": "a0fb1466af2494dae01e80c9dcfa9931a8c593158addd68103030132befcad7d.1657625752257",
  "phoneNumber": "9412580180",
  "userId": "62cd5be42c9b5e4cc67ebdbe"
}

- go to `/user/verifyOTP` **post** request and just enter `otp`, `hash`, `phone_number` 
### Output
> {
  "x-api-key": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2MmNkNWJlNDJjOWI1ZTRjYzY3ZWJkYmUiLCJpc1JlZnJlc2hUb2tlbiI6ZmFsc2UsImlhdCI6MTY1NzYyNTY0NSwiZXhwIjoxNjU3ODg0ODQ1fQ.fxopBmv-ZSg3s6j37eT3fgf-cpSApv26PAxDDi35QrQv3hYPw9NxUlZPKghh-5K_5NKl5xY_AHwV74XlvJpRQyPOsmoQ47hp5lb5UM_SwsrVhIpnsEBTorG5IY63dU_ywyxHy1XybKRxl1diuh83ilPI50FOterEsdDkJ-WXAjCYOFXN-jGTbMTHrrstkvAE2LuTVzmUy2n3JtaArfEdreLw7cnLMMiJwiqeiRYamJ_-BnDuxr49J_7yvgtemvB27-nR9b5jHf7raAgYY0HuVMidpJ7mUP-BJu2CKOgAcaQA5eL2mv_mrTV-mxNQ1HfYxRGuuh2eADe5-V0ygaXh-Q",
  
  "refresh-token": "eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2MmNkNWJlNDJjOWI1ZTRjYzY3ZWJkYmUiLCJpc1JlZnJlc2hUb2tlbiI6dHJ1ZSwiaWF0IjoxNjU3NjI1NjQ1LCJleHAiOjE2NTc3MTIwNDV9.t4SRupS4kct59VO93iyb-NThGrZ9VGiwMmeEx4k_MfzIwj3jlTCLKyt17ijdEut_XeM0GBpW5S1ZRlsRw3EA0ZF0DuBWNt9vKGnxkrT7ldE7uaMefoDt5eEgP_bgJkjmYUIUn3SonDz4sPw-jd47mEGTFnB5ZCntpOGaUhIZF8VKXIfLUb7VlcAr-EjOForpOqWe3doE6_Xbla2APw6pRjzfqSe87geqlg8zxqDAJm1_VB5lXfYL3ocZ3BqpVP0_NAvI10i-W0svXUJ1J8v2DwkBzzDM6-kGLwAWSMxlMVoUTMCggP_HHGgV3ULcyQeD4Ze4C_vS7MWV4qY00xY4Gg"
}

## Create a application

- go to `/app` **post** request and `x-api-key` for `application admin` 

### Output
> {
  "appId": "62cd5d0d2c9b5e4cc67ebdbf",
  "appSecret": "ff97d7efee39482fbb14db8a4088aaa3"
}

## Create a first payment collector / merchant / event organizer for above created app
 
- same as user register role: `merchant` and `x-api-key` in output

> eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiI2MmNkNWY0OTJjOWI1ZTRjYzY3ZWJkYzAiLCJpc1JlZnJlc2hUb2tlbiI6ZmFsc2UsImlhdCI6MTY1NzYyNzA0NCwiZXhwIjoxNjU3ODg2MjQ0fQ.FnVn4vfOKbYQfBzqjLw47P7J1B-_x-0uE1L5wHsp4LUvae-lzHNeGo_PlzixSojXzx_guwHFSxU1VFqtyygElwX8LG2d6aadlAo-gVlMbzH8AJECIYmQfDcRu4eVPs55Q4D4xFOSom9PJNIYEWMzgvkjn5m90c76Pr1p32Tx7jka_ijWegqO7QVZnl9Svrxo-wZSI6o59qYpxl2wgc5FqLych0ucXvZCtZAV3WRxV1PG1Hduo59DMTzHnI47IxqsEgUHQ60CPSV1Fb5S6Jhbf3jGLIjzAcweRDCEP56qDjdUyxdJedaIEhVZVor-qelXVNFCXNKUBR5JlrMslXx2Vw

## create a customer for a specific payment collector

- same as user register role: `customer` required `x-api-key` of `collector`

## KYC Process for Agent(App-Admin) and Merchant(Event-Organizer) 

## Create a Payment Link / Bill

- go to `/payment/bill` **post** request 
- mention `x-api-key` for money collector `app-id`, `app-secret`
- mention body 
```
{
  "customerId": "string",
  "billerId": "string",
  "additionalInfo": {
    "key": "string"
  },
  "amountRanges": {
    "minAmount": 0,
    "maxAmount": 0
  },
  "paymentGateway": "setu"
}
```


-----

## how to get Notification for payment for a bill ?
1) add a callback_url and callback_secret in app
2) generate a bill and after payment a request generated towards your callback_url with `payload` and `x-pay-signature-256`

> ### Sample
 >> payload
```
{
  "amountRanges": {
    "minAmount": 1,
    "maxAmount": 10
  },
  "paymentGatewayInfo": {
    "platformId": "91e28763-8710-41a7-b9be-06475d9705f2",
    "paymentGateway": "mockpay",
    "paymentLink": "http://localhost:8000/paylink/bill/pay/91e28763-8710-41a7-b9be-06475d9705f2"
  },
  "status": "payment_bill.partially_paid",
  "_id": "6249b31bcdc6d07c4d4d5704",
  "billerId": "order9220",
  "additionalInfo": {
    "description": "khadi silk saree"
  },
  "merchant": "623b706a4d0978e9b9a50b29",
  "customer": "6240b4cbca66e008b705ae16",
  "app": "6239e60f9cc6583653c6243a",
  "billCreatedAt": "2022-04-03T14:45:47.312Z",
  "payments": [
    {
      "amountPaid": 1,
      "createdAt": "2022-04-03T15:09:58.580561Z"
    },
    {
      "amountPaid": 1,
      "createdAt": "2022-04-03T15:10:39.525193Z"
    },
    {
      "amountPaid": 1,
      "createdAt": "2022-04-03T15:11:13.067180Z"
    },
    {
      "amountPaid": 1,
      "createdAt": "2022-04-03T15:11:23.175197Z"
    },
    {
      "amountPaid": 1,
      "createdAt": "2022-04-03T15:13:26.545701Z"
    },
    {
      "amountPaid": 1,
      "createdAt": "2022-04-03T15:13:58.187153Z"
    }
  ],
  "__v": 0
}

```
  >> headers
  ```
  x-pay-signature-256	: sha256=b9ce2873c828a8e4b56c89d0144bb602f8ab994aa254ab278b68fbf58a44fc2c

  ```

## How to trust the source of notification that request is coming from payment-service ?

### `NodeJS`
```
app.post('/notification',function(req,res) {
    const decrypted = crypto.createHmac('sha256',env[key]).update(JSON.stringify(req.body)).digest('hex');
    if(req.headers["x-pay-signature-256"] === `sha256=${decrypted}`){
        console.log('Access granted');
        res.json({'status': 200});
    }
    else {
        console.log('Access denied')
        res.json({'status': 401});
    }
});
```
### `Python`
```
import hashlib
import hmac
import json

incoming_payload = {"amountRanges":{"minAmount":1,"maxAmount":10},"paymentGatewayInfo":{"platformId":"91e28763-8710-41a7-b9be-06475d9705f2","paymentGateway":"mockpay","paymentLink":"http://localhost:8000/paylink/bill/pay/91e28763-8710-41a7-b9be-06475d9705f2"},"status":"payment_bill.partially_paid","_id":"6249b31bcdc6d07c4d4d5704","billerId":"order9220","additionalInfo":{"description":"khadi silk saree"},"merchant":"623b706a4d0978e9b9a50b29","customer":"6240b4cbca66e008b705ae16","app":"6239e60f9cc6583653c6243a","billCreatedAt":"2022-04-03T14:45:47.312Z","payments":[{"amountPaid":1,"createdAt":"2022-04-03T15:09:58.580561Z"},{"amountPaid":1,"createdAt":"2022-04-03T15:10:39.525193Z"},{"amountPaid":1,"createdAt":"2022-04-03T15:11:13.067180Z"},{"amountPaid":1,"createdAt":"2022-04-03T15:11:23.175197Z"},{"amountPaid":1,"createdAt":"2022-04-03T15:13:26.545701Z"},{"amountPaid":1,"createdAt":"2022-04-03T15:13:58.187153Z"}],"__v":0}

incoming_header = {"x-pay-signature-256":"sha256=b9ce2873c828a8e4b56c89d0144bb602f8ab994aa254ab278b68fbf58a44fc2c"}

# should be in env
CALLBACK_SECRET = "secret"
def webhook_challenge():
  hmac_digest = hmac.new(key=bytes(CALLBACK_SECRET, "utf-8"),msg=bytes(json.dumps(incoming_payload, separators=(',', ':')), "utf-8"),digestmod=hashlib.sha256).hexdigest()
  print(f"sha256={hmac_digest}")
  if f"sha256={hmac_digest}"==incoming_header["x-pay-signature-256"]:
    print("data is coming from payment-service")
  else:
    print("incoming data is coming from wrong end!")

webhook_challenge()


```

## Payment Links Notifications by third party gateways
- Cashfree
    https://docs.cashfree.com/docs/payment-links-webhooks#payload
- Razorpay
    https://razorpay.com/docs/webhooks/payloads/payment-links/
- Setu
    https://docs.setu.co/payments/upi-deeplinks/notifications
- MockPay(notification response payload)

```{
  "platform_id": "1206ba25-7ad8-4db4-9ab4-1cf02a55422f",
  "payment_set": [
    {
      "amount_paid": 100,
      "created_at": "2022-03-31T16:37:53.275382Z"
    },
    {
      "amount_paid": 100,
      "created_at": "2022-03-31T16:40:42.820398Z"
    },
    {
      "amount_paid": 1800,
      "created_at": "2022-03-31T16:41:00.402833Z"
    }
  ],
  "first_min_amount": 100,
  "payee_name": "Muscle House",
  "max_amount": 2000,
  "status": "paid",
  "biller_id": "Order240",
  "callback_url": "https://webhook.site/d895d404-3343-41e2-b274-4da29b74d5de",
  "payment_link": "http://localhost:8000/paylink/bill/pay/1206ba25-7ad8-4db4-9ab4-1cf02a55422f",
  "merchant": 1
}
```

